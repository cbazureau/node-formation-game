<html>
  <head>
    <title>Reversi Game</title>
    <script src="socket.io.js"></script>
    <style>
      body {
        background: #eee;
        font-size: 10px;
      }
      #container {
        display: flex;
        align-items: flex-start;
        justify-content: center;
        margin: 20px 0;
      }
      #log {
        width: 300px;
        height: 497px;
        overflow-y: scroll;
        background: white;
        padding: 5px;
        margin-left: 20px;
        border: 1px solid gray;
        font-size: 0.9rem;
      }
      #log .success {
        color: green;
      }
      #log .error {
        color: red;
      }
      #gameboard table {
        table-layout: fixed;
        border: 10px solid brown;
        border-spacing: 1px;
      }
      #gameboard table td {
        width: 60px;
        height: 60px;
        padding: 0;
        margin: 0;
        position: relative;
      }
      .piece {
        display: block;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        position: absolute;
        top: 50%;
        left: 50%;
        background: transparent;
        transition: background-color 0.5s;
        transform: translate3d(-50%, -50%, 0);
      }
      .piece-white {
        background: white;
      }
      .piece-black {
        background: black;
      }

    </style>
    <script>
      var TABLE_LOADED = false;

      // Start
      function start() {
        document.getElementById('log').innerHTML = "";
        fetch('/start');
      }

      // Add action in log Panel
      function addAction({ errorName, uri }) {
        const div = document.createElement('div');
        if(errorName === 'OK') {
          div.innerHTML = `${uri}`;
          div.className = 'success';
        } else {
          div.innerHTML = `${uri} - ${errorName}`;
          div.className = 'error';
        }
        document.getElementById('log').appendChild(div);
        document.getElementById('log').scrollTo(0,document.getElementById('log').scrollHeight);
      }
      // reloadTable
      function reloadTable({ matrix, uri, next }) {
        if(uri) addAction({
          errorName: 'OK',
          uri,
        })
        if(!TABLE_LOADED) {
          document.getElementById('gameboard').innerHTML = "";
          const table = document.createElement('table');
          document.getElementById('gameboard').appendChild(table);
          for (var i = 0; i < matrix.length; i++) {
            var tr = document.createElement('tr');
            table.appendChild(tr);
            for (var j = 0; j < matrix[i].length; j++) {
              var tdElement = document.createElement('td');
              tdElement.bgColor = 'green';
              tr.appendChild(tdElement);
              var span = document.createElement('span');
              span.setAttribute('url', `./play/${next}/${i}/${j}`)
              span.onclick = function () {
                fetch(this.getAttribute('url'))
              };
              span.className = `piece piece-${matrix[i][j]} pos-${i}-${j}`;
              tdElement.appendChild(span);
            }
          }
        }

        for (var i = 0; i < matrix.length; i++) {
          for (var j = 0; j < matrix[i].length; j++) {
            var elem = document.getElementsByClassName(`pos-${i}-${j}`)[0];
            elem.setAttribute('url', `./play/${next}/${i}/${j}`);
            if(!elem.classList.contains(`piece-${matrix[i][j]}`)) {
              if(matrix[i][j] === 'white' || matrix[i][j] === 'green') elem.classList.remove(`piece-black`);
              if(matrix[i][j] === 'black' || matrix[i][j] === 'green') elem.classList.remove(`piece-white`);
              if(matrix[i][j] !== 'green') elem.classList.add(`piece-${matrix[i][j]}`)
            }
          }
        }

        TABLE_LOADED = true;
      }
    </script>
  </head>
  <body>
    <button onClick="start()">Start</button>
    <div id="container">
      <div id="gameboard"></div>
      <div id="log"></div>
    </div>
    <script>
      const socket = io('http://localhost:3005')
      socket.on('refresh', reloadTable)
      socket.on('error', addAction)
      socket.emit('change color', 'red')
    </script>
  </body>
</html>
