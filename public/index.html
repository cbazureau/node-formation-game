<html>
  <head>
    <title>Reversi Game</title>
    <script src="socket.io.js"></script>
    <style>
      body {
        background: #eee;
        font-size: 10px;
      }
      #container {
        display: flex;
        align-items: flex-start;
        justify-content: center;
        margin: 20px 0;
      }
      #log {
        width: 300px;
        height: 497px;
        overflow-y: scroll;
        background: white;
        padding: 5px;
        margin-left: 20px;
        border: 1px solid gray;
        font-size: 0.9rem;
      }
      #log .success {
        color: green;
      }
      #log .error {
        color: red;
      }
      #gameboard table {
        table-layout: fixed;
        border: 10px solid brown;
        border-spacing: 1px;
      }
      #gameboard table td {
        width: 60px;
        height: 60px;
        padding: 0;
        margin: 0;
        position: relative;
      }
      .piece {
        cursor: pointer;
        display: block;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        position: absolute;
        top: 50%;
        left: 50%;
        background: transparent;
        transition: background-color 0.5s, border 0.5s;
        transform: translate3d(-50%, -50%, 0);
        border: 1px solid transparent;
        font-size: 1.4rem;
        font-weight: bold;
        line-height: 50px;
        text-align: center;
      }
      .piece-white {
        background: white;
        color: black;
      }
      .piece-black {
        background: black;
        color: white;
      }
      .piece-border-black {
        border: 1px solid rgb(0, 0, 0, 0.4);
      }
      .piece-border-white {
        border: 1px solid rgb(255, 255, 255, 0.4);
      }

      .score {
        width: 60px;
        height: 60px;
        position: relative;
      }

      .btn {
        border-radius: 50%;
        width: 60px;
        height: 60px;
        border: 1px solid gray;
        cursor: pointer;
        font-weight: bold;
      }

      .btn-restart {
        background: red;
        color: white;
        border: 1px solid gray;
      }
      .btn-white {
        background: white;
        color: black;
        border: 1px solid gray;
      }
      .btn-black {
        background: black;
        color: white;
        border: 1px solid gray;
      }

      .btn:disabled {
        background: white;
        color: black;
        border: 1px solid gray;
        opacity: 0.2;
        cursor: not-allowed;
      }

      #statusbar {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        background: white;
        width: 400px;
        margin: 20px auto;
        padding: 10px;
        border-radius: 20px;
      }
      .title {
        font-size: 1.4rem;
        padding: 0 20px;
        font-weight: bold;
      }

    </style>
    <script>
      var TABLE_LOADED = false;
      var CURRENT_PLAYER = undefined;

      // Start
      function start() {
        document.getElementById('log').innerHTML = "";
        fetch('/restart');
      }
      // Pass
      function pass() {
        fetch(`/pass/${CURRENT_PLAYER}`);
      }

      // Add action in log Panel
      function addAction({ status, uri }) {
        const div = document.createElement('div');
        if(status === 'OK') {
          div.innerHTML = `${uri}`;
          div.className = 'success';
        } else {
          div.innerHTML = `${uri} - ${status}`;
          div.className = 'error';
        }
        document.getElementById('log').appendChild(div);
        document.getElementById('log').scrollTo(0,document.getElementById('log').scrollHeight);
      }
      // reloadTable
      function reloadTable({ matrix, uri, next, status, playablePlaces, counter, pass }) {
        addAction({
          status,
          uri,
        });
        if(!TABLE_LOADED) {
          document.getElementById('gameboard').innerHTML = "";
          const table = document.createElement('table');
          document.getElementById('gameboard').appendChild(table);
          for (var i = 0; i < matrix.length; i++) {
            var tr = document.createElement('tr');
            table.appendChild(tr);
            for (var j = 0; j < matrix[i].length; j++) {
              var tdElement = document.createElement('td');
              tdElement.bgColor = 'green';
              tr.appendChild(tdElement);
              var span = document.createElement('span');
              span.setAttribute('url', `./play/${next}/${i}/${j}`)
              span.onclick = function () {
                fetch(this.getAttribute('url'))
              };
              span.className = `piece piece-${matrix[i][j]} pos-${i}-${j}`;
              tdElement.appendChild(span);
            }
          }
        }

        for (var i = 0; i < matrix.length; i++) {
          for (var j = 0; j < matrix[i].length; j++) {
            var elem = document.getElementsByClassName(`pos-${i}-${j}`)[0];
            elem.setAttribute('url', `./play/${next}/${i}/${j}`);
            if(!elem.classList.contains(`piece-${matrix[i][j]}`)) {
              elem.classList.remove(`piece-black`);
              elem.classList.remove(`piece-white`);
              elem.classList.remove(`piece-green`);

              if(matrix[i][j] !== 'green') elem.classList.add(`piece-${matrix[i][j]}`)
            }
            elem.classList.remove(`piece-border-white`);
            elem.classList.remove(`piece-border-black`);
            if(playablePlaces.some(p => (p[0] === i && p[1] === j))) {
              elem.classList.add(`piece-border-${next}`)
            }
          }
        }

        document.getElementById('btn-pass').innerHTML = `${playablePlaces.length} plays`;
        document.getElementById('counter-black').innerHTML = counter.black;
        document.getElementById('counter-white').innerHTML = counter.white;
        document.getElementById('btn-pass').classList.remove(`btn-black`);
        document.getElementById('btn-pass').classList.remove(`btn-white`);
        document.getElementById('btn-pass').classList.add(`btn-${next}`);
        document.getElementById('btn-pass').setAttribute('disabled', playablePlaces.length === 0);
        TABLE_LOADED = true;
        CURRENT_PLAYER = next;
      }
    </script>
  </head>
  <body>
    <div id="statusbar">
      <div class="actions">
        <button onClick="start()" class="btn btn-restart">Restart</button>
        <button onClick="pass()" id="btn-pass" class="btn btn-pass">Pass</button>
      </div>
      <div class="title">Bot Othello</div>
      <div class="score"><span id="counter-white" class="piece piece-white piece-border-black"></span></div>
      <div class="score"><span id="counter-black" class="piece piece-black piece-border-black"></span></div>
    </div>
    <div id="container">
      <div id="gameboard"></div>
      <div id="log"></div>
    </div>
    <script>
      const socket = io('http://localhost:3005')
      socket.on('refresh', reloadTable)
      socket.emit('change color', 'red')
    </script>
  </body>
</html>
